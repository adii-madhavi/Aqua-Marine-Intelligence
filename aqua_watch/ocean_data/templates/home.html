<!DOCTYPE html>
<html>
<head>
    <title>Aqua Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --teal: #00695c; --bg: #f0f4f8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: var(--teal); color: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; }
        .container { width: 90%; max-width: 1200px; margin: 2rem auto; }
        .glass { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input { padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--teal); }
        button { background: var(--teal); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        #map { height: 400px; border-radius: 15px; z-index: 1; border: 2px solid #ddd; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; border-radius: 10px; overflow: hidden; }
        th { background: #eee; padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .rec-item { background: #e0f2f1; padding: 12px; border-radius: 8px; margin: 5px 0; border-left: 5px solid var(--teal); }
    </style>
</head>
<body>

<header>
    <h2>Aqua Marine Intelligence</h2>
    <div id="auth-controls">
        <button onclick="handleLogout()" style="background:#c62828">Logout</button>
    </div>
</header>

<div class="container" id="auth-box">
    <div class="glass" style="max-width: 400px; margin: auto; text-align: center;">
        <h3>Login to Continue</h3>
        <input type="text" id="user" placeholder="Username" style="width: 90%"><br><br>
        <input type="password" id="pass" placeholder="Password" style="width: 90%"><br><br>
        <button onclick="auth('login')" style="width: 98%">Login</button>
        <p style="font-size: 0.8rem; margin-top: 15px;">New? <a href="#" onclick="auth('signup')">Create account</a></p>
    </div>
</div>

<div class="container" id="main-dash" style="display:none;">
    <div class="glass">
        <h3>üìç Coastal Map Visualization</h3>
        <div id="map"></div>
    </div>

    <div class="glass">
        <h3>üõ† Environmental Data Input</h3>
        <div class="input-group">
            <input type="text" id="loc" placeholder="Location (e.g. Mumbai Sea)">
            <input type="number" id="tmp" oninput="getRecs()" placeholder="Temp ¬∞C">
            <input type="number" id="slt" oninput="getRecs()" placeholder="Salinity (ppt)">
            <button onclick="saveData()">Save Entry</button>
        </div>
        <div id="recs-box"></div>
    </div>

    <div class="glass">
        <h3>üìÑ Environmental Logs</h3>
        <table>
            <thead><tr><th>Location</th><th>Temp</th><th>Salinity</th><th>Status</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <div class="glass">
        <h3>üß¨ Species Master Requirements (¬±2¬∞C Interval)</h3>
        <table>
            <thead><tr><th>Species</th><th>Description</th><th>Temp Window</th><th>Ideal Salt</th><th>Ideal pH</th></tr></thead>
            <tbody id="species-body"></tbody>
        </table>
    </div>
</div>

<script>
    // Initialize Leaflet Map centered on coastal area
    var map = L.map('map').setView([19.0760, 72.8777], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var markersLayer = L.layerGroup().addTo(map);

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break;
                }
            }
        } return cookieValue;
    }

    async function auth(type) {
        const res = await fetch(`/api/${type}/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify({username: document.getElementById('user').value, password: document.getElementById('pass').value})
        });
        const data = await res.json();
        alert(data.message);
        if(data.message.includes("successful")) {
            document.getElementById('auth-box').style.display = 'none';
            document.getElementById('main-dash').style.display = 'block';
            setTimeout(() => { map.invalidateSize(); }, 200);
            loadTable(); loadSpeciesTable();
        }
    }

    async function getRecs() {
        const t = document.getElementById('tmp').value;
        const s = document.getElementById('slt').value;
        if(!t || !s) return;
        const res = await fetch(`/api/recommend/?temp=${t}&salinity=${s}`);
        const data = await res.json();
        let html = '<strong>Live Recommendations:</strong>';
        data.forEach(i => { html += `<div class="rec-item">${i.name} - ${i.desc}</div>`; });
        document.getElementById('recs-box').innerHTML = html;
    }

    async function saveData() {
        const locName = document.getElementById('loc').value;
        if (!locName) { alert("Please enter a location"); return; }

        // Fetch coordinates from Nominatim API
        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locName)}`);
        const geoData = await geoRes.json();
        
        let finalLat = 19.0760, finalLng = 72.8777; 
        if (geoData.length > 0) {
            finalLat = parseFloat(geoData[0].lat);
            finalLng = parseFloat(geoData[0].lon);
        }

        const res = await fetch('/api/add-record/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify({
                location: locName,
                temperature: document.getElementById('tmp').value,
                salinity: document.getElementById('slt').value,
                lat: finalLat,
                lng: finalLng
            })
        });
        const data = await res.json();
        alert(data.message);
        loadTable();
    }

    async function loadTable() {
        const res = await fetch('/api/get-all-records/');
        const data = await res.json();
        let html = '';
        markersLayer.clearLayers(); // Remove old markers to fix "duplicate" visuals

        data.forEach(r => {
            html += `<tr><td>${r.location}</td><td>${r.temperature}¬∞C</td><td>${r.salinity}</td><td><b style="color:${r.status=='DANGER'?'red':'green'}">${r.status}</b></td></tr>`;
            
            // Use ACTUAL latitude and longitude from the database
            if (r.latitude && r.longitude) {
                L.marker([r.latitude, r.longitude])
                 .addTo(markersLayer)
                 .bindPopup(`<b>${r.location}</b><br>Temp: ${r.temperature}¬∞C<br>Salinity: ${r.salinity} ppt`);
            }
        });
        document.getElementById('table-body').innerHTML = html;
    }

    async function loadSpeciesTable() {
        const res = await fetch('/api/species/');
        const data = await res.json();
        let html = '';
        data.forEach(s => {
            html += `<tr><td><strong>${s.name}</strong></td><td><small>${s.description}</small></td><td>${s.min_temp}¬∞C - ${s.max_temp}¬∞C</td><td>${s.salinity} ppt</td><td>${s.ph}</td></tr>`;
        });
        document.getElementById('species-body').innerHTML = html;
    }

    function handleLogout() {
        fetch('/api/logout/').then(() => location.reload());
    }
</script>
</body>
</html>